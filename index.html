<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Телефонни консултации</title>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; line-height: 1.35; }
    h1 { margin: 0 0 12px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: start; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; }
    label { display:block; font-size: 13px; margin: 10px 0 6px; }
    input, select, button { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; }
    button { cursor: pointer; }
    button.primary { border: 0; background: #111; color: #fff; }
    button.secondary { background: #f3f3f3; }
    button.danger { border: 0; background: #b00020; color: #fff; }
    .row { display:flex; gap: 10px; }
    .row > * { flex: 1; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eee; padding: 10px 8px; text-align: left; }
    th { font-size: 12px; color: #444; }
    .muted { color: #666; font-size: 12px; }
    .msg { margin-top: 10px; padding: 10px; border-radius: 8px; border: 1px solid #ddd; background: #fafafa; }
    .msg.warn { border-color: #f0d9a6; background: #fffaf0; }
    .msg.err { border-color: #f0b6b6; background: #fff5f5; }
    .right { text-align:right; }
    .busy { opacity: 0.6; pointer-events: none; }

    .header-row { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .header-row h2 { margin: 0; }
    .header-row .actions { display:flex; gap:10px; }
    .header-row .actions button { width:auto; }
  </style>
</head>

<body>
  <h1>Телефонни консултации</h1>

  <div class="grid">
    <div class="card">
      <h2>Нов пациент</h2>

      <label>Първо име</label>
      <input id="firstName">

      <label>Фамилия</label>
      <input id="lastName">

      <button class="primary" id="addPatientBtn">Добави пациент</button>
      <div id="patientMsg" class="msg" style="display:none;"></div>

      <hr>

      <h3>Нов пакет</h3>

      <label>Пациент</label>
      <select id="patientForPackage"></select>

      <label>Дата на покупка</label>
      <input type="date" id="packageDate">

      <label>Брой консултации</label>
      <input type="number" id="packageSize" value="5" min="1">

      <button class="primary" id="addPackageBtn">Добави пакет</button>
      <div id="packageMsg" class="msg" style="display:none;"></div>
    </div>

    <div class="card">
      <h2>Нова консултация</h2>

      <label>Пациент</label>
      <select id="patientForConsult"></select>

      <label>Дата</label>
      <input type="date" id="consultDate">

      <button class="primary" id="addConsultBtn">Добави консултация</button>
      <div id="consultMsg" class="msg" style="display:none;"></div>
    </div>
  </div>

  <div class="card" style="margin-top:16px;">
    <div class="header-row">
      <h2>Отчет по пакети</h2>
      <div class="actions">
        <button class="secondary" id="exportBtn">Експорт (Excel)</button>
      </div>
    </div>

    <table style="margin-top:10px;">
      <thead>
        <tr>
          <th>Пациент</th>
          <th>Пакет</th>
          <th>Проведени / Остават</th>
          <th class="right">Действия</th>
        </tr>
      </thead>
      <tbody id="packagesTable"></tbody>
    </table>
  </div>

  <!-- SheetJS за .xlsx -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
(() => {
  const SCRIPT_URL = "/.netlify/functions/api";

  let state = { patients: [], packages: [], consultations: [] };
  let busy = false;

  function setBusy(v) {
    busy = v;
    document.body.classList.toggle("busy", v);
  }

  function formatDate(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    const pad = n => String(n).padStart(2, "0");
    return `${pad(d.getDate())}.${pad(d.getMonth() + 1)}.${d.getFullYear()}`;
  }

  function todayISO() {
    return new Date().toISOString().slice(0, 10);
  }

  async function api(action, payload = {}) {
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action, payload })
    });
    const json = await res.json();
    if (!json.ok) throw new Error(json.error || "API error");
    return json.data;
  }

  const el = id => document.getElementById(id);

  async function refresh() {
    setBusy(true);
    try {
      state = await api("getState");
      render();
    } catch (e) {
      alert(e.message);
    }
    setBusy(false);
  }

  function render() {
    const selects = [el("patientForPackage"), el("patientForConsult")];
    selects.forEach(s => {
      s.innerHTML = "";
      state.patients.forEach(p => {
        if (String(p.archived).toLowerCase() === "true") return;
        const o = document.createElement("option");
        o.value = p.patientId;
        o.textContent = p.firstName + " " + p.lastName;
        s.appendChild(o);
      });
    });

    const tbody = el("packagesTable");
    tbody.innerHTML = "";

    state.packages.forEach(pkg => {
      const p = state.patients.find(x => x.patientId === pkg.patientId);
      const used = state.consultations.filter(c => c.packageId === pkg.packageId).length;
      const left = Number(pkg.size) - used;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p ? (p.firstName + " " + p.lastName) : "?"}</td>
        <td>${formatDate(pkg.purchaseDate)}</td>
        <td>${used} / ${left}</td>
        <td class="right">
          <button class="danger" data-id="${pkg.packageId}">Изтрий</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ✅ Excel Export: 1 ред = 1 пакет + списък с дати на консултации
  function exportToExcel() {
    if (!window.XLSX) {
      alert("Липсва библиотека за Excel export (XLSX).");
      return;
    }

    const patientMap = new Map(state.patients.map(p => [p.patientId, p]));

    // групираме консултациите по пакет
    const consultsByPkg = new Map();
    for (const c of state.consultations) {
      const arr = consultsByPkg.get(c.packageId) || [];
      arr.push(c);
      consultsByPkg.set(c.packageId, arr);
    }

    // сортираме датите в пакета
    for (const [pkgId, arr] of consultsByPkg.entries()) {
      arr.sort((a,b) => String(a.date).localeCompare(String(b.date)));
      consultsByPkg.set(pkgId, arr);
    }

    // 1 ред = 1 пакет
    const rows = state.packages
      .slice()
      .sort((a,b) => String(a.purchaseDate).localeCompare(String(b.purchaseDate)))
      .map(pkg => {
        const pat = patientMap.get(pkg.patientId);
        const patientName = pat ? `${pat.firstName} ${pat.lastName}` : "(липсващ пациент)";

        const consults = consultsByPkg.get(pkg.packageId) || [];
        const done = consults.length;
        const left = Math.max(0, Number(pkg.size) - done);

        const consultDatesList = consults.map(c => formatDate(c.date)).join(", ");

return {
  "Пациент": patientName,
  "Дата покупка (пакет)": formatDate(pkg.purchaseDate),
  "Дати консултации": consultDatesList,
  "Проведени (в пакета)": done,
  "Оставащи (в пакета)": left,
  "Статус": left > 0 ? "Активен" : "Изчерпан"
};
      });

    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Packages");

    const filename = `phone-consultations-${todayISO()}.xlsx`;
    XLSX.writeFile(wb, filename);
  }

  // Init inputs
  el("packageDate").value = todayISO();
  el("consultDate").value = todayISO();

  el("addPatientBtn").onclick = async () => {
    try {
      await api("addPatient", {
        firstName: el("firstName").value,
        lastName: el("lastName").value
      });
      el("firstName").value = "";
      el("lastName").value = "";
      refresh();
    } catch (e) { alert(e.message); }
  };

  el("addPackageBtn").onclick = async () => {
    try {
      await api("addPackage", {
        patientId: el("patientForPackage").value,
        purchaseDate: el("packageDate").value,
        size: Number(el("packageSize").value)
      });
      refresh();
    } catch (e) { alert(e.message); }
  };

  el("addConsultBtn").onclick = async () => {
    try {
      await api("addConsultation", {
        patientId: el("patientForConsult").value,
        date: el("consultDate").value
      });
      refresh();
    } catch (e) { alert(e.message); }
  };

  // delete package
  el("packagesTable").addEventListener("click", async (e) => {
    const btn = e.target.closest("button");
    if (!btn) return;
    const pkgId = btn.dataset.id;
    if (!pkgId) return;

    const ok = confirm("Сигурен ли си, че искаш да изтриеш този пакет? Това ще изтрие и консултациите към него.");
    if (!ok) return;

    try {
      await api("deletePackage", { packageId: pkgId });
      refresh();
    } catch (err) {
      alert(err.message);
    }
  });

  el("exportBtn").onclick = () => {
    try { exportToExcel(); } catch (e) { alert(e.message); }
  };

  refresh();
})();
</script>
</body>
</html>
